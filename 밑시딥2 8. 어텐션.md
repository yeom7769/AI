# ë°‘ì‹œë”¥2 ğŸ“‚8. ì–´í…ì…˜

ì´ì „ ì¥ì—ì„œëŠ” RNNê³¼ seq2seqì— ëŒ€í•´ ë°°ì›Œë³´ì•˜ë‹¤.

ì´ë²ˆ ì¥ì—ì„œëŠ” seq2seq ê°€ëŠ¥ì„±ê³¼ RNN ê°€ëŠ¥ì„±ì— ëŒ€í•´ ê¹Šê²Œ ì‚´í´ë³¸ë‹¤.

ëª©í‘œëŠ” ì–´í…ì…˜ì˜ êµ¬ì¡°ë¥¼ ì½”ë“œ ìˆ˜ì¤€ì—ì„œ ì´í•´í•˜ëŠ” ê²ƒ, ì‹¤ì œ ë¬¸ì œì— ì ìš©í•´ë³´ëŠ” ê²ƒì´ë‹¤.



## 1. ì–´í…ì…˜ì˜ êµ¬ì¡°

seq2seqëŠ” ë‹¤ì–‘í•˜ê²Œ ì‘ìš©í•  ìˆ˜ ìˆë‹¤. ì§€ê¸ˆê¹Œì§€ ë°°ìš´ seq2seqë¥¼ í•œì¸µ ë” ê°•ë ¥í•˜ê²Œ í•˜ëŠ” **`ì–´í…ì…˜ ë§¤ì»¤ë‹ˆì¦˜`**ì„ ì•Œì•„ë³´ì.

ğŸ“ ì–´í…ì…˜ ë§¤ì»¤ë‹ˆì¦˜ : seq2seqê°€ í•„ìš”í•œ ì •ë³´ì— ì£¼ëª©í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ê³  seq2seqì˜ ë¬¸ì œì  ê°œì„ ì´ ê°€ëŠ¥í•˜ë‹¤.



### 1.1 seq2seqì˜ ë¬¸ì œì 

seq2seqì—ì„œëŠ” Encoderê°€ ì‹œê³„ì—´ ë°ì´í„°ë¥¼ ì¸ì½”ë”©í•œë‹¤. ì´ ì¸ì½”ë”©ëœ ì •ë³´ë¥¼ Decoderë¡œ ì „ë‹¬í•œë‹¤. ì´ë•Œ ì •ë³´ëŠ” 'ê³ ì • ê¸¸ì´ì˜ ë²¡í„°'ì´ë‹¤.

ê³ ì • ê¸¸ì´ ë²¡í„°ëŠ” ì…ë ¥ ë¬¸ì¥ì˜ ê¸¸ì´ì— ê´€ê³„ì—†ì´ í•­ìƒ ê°™ì€ ê¸¸ì´ì˜ ë²¡í„°ë¡œ ë³€í™˜í•œë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-1.png" alt="fig 8-1" style="zoom:50%;" />



ğŸ™„ ì´ ë•Œ, í•„ìš”í•œ ì •ë³´ê°€ ë²¡í„°ì— ë‹¤ ë‹´ê¸°ì§€ ëª»í•˜ëŠ” ë¬¸ì œì  ë°œìƒ!



### 1.2 Encoder ê°œì„ 

ê¸°ì¡´ seq2seq êµ¬ì¡°ëŠ” LSTM ê³„ì¸µì˜ ë§ˆì§€ë§‰ ì€ë‹‰ ìƒíƒœë§Œ Decoder ì— ì „ë‹¬í–ˆë‹¤.

ğŸŒŸ**<u>Encoderì˜ ì¶œë ¥ ê¸¸ì´ëŠ” ì…ë ¥ ë¬¸ì¥ì˜ ê¸¸ì´ì— ë”°ë¼ ë°”ê¿”ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤.</u>**

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 7-9.png" alt="fig 7-9" style="zoom:50%;" />

 <img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-2.png" alt="fig 8-2" style="zoom:50%;" />

ğŸ™„ ê°œì„ ëœ seq2seqì˜ êµ¬ì¡°ì—ì„œ LSTM ê³„ì¸µì˜ ì€ë‹‰ìƒíƒœì—ëŠ” ì–´ë– í•œ ì •ë³´ê°€ ë‹´ê²¨ ìˆë‚˜?

ê° ì‹œê°ì˜ ì€ë‹‰ ìƒíƒœì—ëŠ” ì§ì „ì— ì…ë ¥ëœ ë‹¨ì–´ì— ëŒ€í•œ ì •ë³´ê°€ ë§ì´ í¬í•¨ë˜ì–´ ìˆë‹¤.

Encoderê°€ ì¶œë ¥í•˜ëŠ” hs í–‰ë ¬ì€ ê° ë‹¨ì–´ì— í•´ë‹¹í•˜ëŠ” ë²¡í„°ë“¤ì˜ ì§‘í•©ì´ë¼ê³  ìƒê°í•  ìˆ˜ ìˆë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-3.png" alt="fig 8-3" style="zoom:50%;" /> 



### 1.3 Decoder ê°œì„ 1ï¸âƒ£

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-4.png" alt="fig 8-4" style="zoom:50%;" /> 

DecoderëŠ” Encoderì˜ ì •ë³´ì¸ hsë¥¼ ì „ë‹¬ë°›ì•„ ì‹œê³„ì—´ ë³€í™˜ì„ ë‹´ë‹¹í•œë‹¤.



ê¸°ì¡´ seq2seqì˜ decoder ê³„ì¸µ êµ¬ì„±ì€ ì•„ë˜ì™€ ê°™ë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-5.png" alt="fig 8-5" style="zoom:50%;" /> 

Encoderì˜ LSTM ê³„ì¸µì˜ ë§ˆì§€ë§‰ ì€ë‹‰ ìƒíƒœë¥¼ Decoderì˜ LSTM ê³„ì¸µì˜ ì²« ì€ë‹‰ ìƒíƒœë¡œ ì„¤ì •í•œë‹¤.

ë•Œë¬¸ì— **<u>hs ì „ë¶€ë¥¼ í™œìš©</u>**í•  ìˆ˜ ìˆë„ë¡ decoderë¥¼ ê°œì„ ì‹œì¼œì•¼í•œë‹¤.

ìš°ë¦¬ëŠ” ë²ˆì—­ì„ í•  ë•Œ ë‹¨ì–´ í•˜ë‚˜ë§ˆë‹¤ì˜ ì˜ë¯¸ë¥¼ ìƒê°í•œë‹¤. ì¦‰, ì–´ë–¤ ë‹¨ì–´ì— ì£¼ëª©í•˜ì—¬ ê·¸ ë‹¨ì–´ì˜ ë³€í™˜ì„ ìˆ˜ì‹œë¡œ ë°˜ë³µí•œë‹¤.

ê·¸ë ‡ë‹¤ë©´ seq2seqì—ê²Œ 'ì…ë ¥ê³¼ ì¶œë ¥ì˜ ì—¬ëŸ¬ ë‹¨ì–´ ì¤‘ ì–´ë–¤ ë‹¨ì–´ë¼ë¦¬ ì„œë¡œ ê´€ë ¨ë˜ì–´ ìˆëŠ”ê°€'ë¼ëŠ” ëŒ€ì‘ ê´€ê³„ë¥¼ í•™ìŠµì‹œí‚¬ ìˆ˜ ìˆëŠ”ê°€?



ìš°ë¦¬ì˜ ëª©í‘œëŠ” <u>í•„ìš”í•œ ì •ë³´ì—ë§Œ ì£¼ëª©í•˜ì—¬ ê·¸ ì •ë³´ë¡œë¶€í„° ì‹œê³„ì—´ ë³€í™˜ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒ</u>ì´ë‹¤. ì´ êµ¬ì¡°ë¥¼ **<u>ì–´í…ì…˜</u>**ì´ë¼ ë¶€ë¥¸ë‹¤.

ì´ë²ˆ ì¥ì—ì„œ êµ¬í˜„í•˜ëŠ” ì‹ ê²½ë§ ê³„ì¸µì˜ êµ¬ì„±ì€ ì•„ë˜ì™€ ê°™ë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-6.png" alt="fig 8-6" style="zoom:50%;" />

ì¶”ê°€ëœ 'ì–´ë–¤ ê³„ì‚°'ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•´ì„œëŠ” 2ê°€ì§€ì˜ ì…ë ¥ì„ ë°›ì•„ì•¼í•œë‹¤. 

í•˜ë‚˜ëŠ” encoderì˜ hs, ë‹¤ë¥¸ í•˜ë‚˜ëŠ” ì‹œê°ë³„ LSTMê³„ì¸µì˜ ì€ë‹‰ ìƒíƒœì´ë‹¤.

ì–´í…ì…˜ êµ¬ì¡°ë¡œ ë¶€í„° ë„ì¶œí•˜ê³  ì‹¶ì€ ê²ƒì€ ë‹¨ì–´ë“¤ì˜ ì–¼ë¼ì¸ë¨¼íŠ¸(ë‹¨ì–´ì˜ ëŒ€ì‘ ê´€ê³„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì •ë³´) ì¶”ì¶œì´ë‹¤.

ì¦‰, ê° ì‹œê°ì—ì„œ decoderì— ì…ë ¥ëœ ë‹¨ì–´ì™€ ëŒ€ì‘ ê´€ê³„ì¸ ë‹¨ì–´ì˜ ë²¡í„°ë¥¼ hsì—ì„œ ì„ íƒí•˜ê² ë‹¤ëŠ” ëœ»ì´ë‹¤.

ğŸ™„ ì´ëŸ¬í•œ ì„ íƒì˜ ê³¼ì •ì„ 'ì–´ë–¤ ê³„ì‚°'ì„ í†µí•´ êµ¬í˜„í•˜ëŠ” ê²ƒì´ë‹¤. ì—¬ê¸°ì„œ ë¬¸ì œì ì€ ì„ íƒí•œëŠ ì‘ì—…ì€ ë¯¸ë¶„ì„ í•  ìˆ˜ ì—†ë‹¤ëŠ” ê²ƒì´ë‹¤.

ğŸ‘‰ ë¬¸ì œì˜ í•´ê²° ë°©ë²•ì€ ê°„ë‹¨í•˜ë‹¤. 'ëª¨ë“  ê²ƒì„ ì„ íƒ'í•˜ëŠ” ê²ƒì´ë‹¤. ì´ë•Œ ê° ë‹¨ì–´ì˜ ì¤‘ìš”ë„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ê°€ì¤‘ì¹˜ë¥¼ ë³„ë„ë¡œ ê³„ì‚°í•˜ë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-7.png" alt="fig 8-7" style="zoom:50%;" /> 

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-8.png" alt="fig 8-8" style="zoom:50%;" /> 

ê·¸ë¦¼ê³¼ ê°™ì´ ë‹¨ì–´ ë²¡í„°ì˜ ê°€ì¤‘í•©ì„ ê³„ì‚°í•˜ê³  ê·¸ ê²°ê³¼ë¥¼ 'ë§¥ë½ ë²¡í„°'ë¼ê³  ë¶€ë¥¸ë‹¤.

```python
T, H = 5, 4
hs = np.random.randn(T, H)
a= np.array([0.8, 0.1, 0.03, 0.05, 0.02])
# ì¤‘ìš”ë„

ar = a.reshape(5, 1).repeat(4, axis = 1)
# (5, 4)
t=hs*ar # ì›ì†Œë³„ ê³±
# (5, 4)
c = np.sum(t, axis=0)
# (4, )
```

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-9.png" alt="fig 8-9" style="zoom:50%;" /> 

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-10.png" alt="fig 8-10" style="zoom:50%;" /> 



- ë¯¸ë‹ˆë°°ì¹˜ ì²˜ë¦¬ìš© ê°€ì¤‘í•© êµ¬í˜„

```python
N, T, H = 10, 5, 4
hs = np.random.randn(N, T, H)
a= np.random.randn(N, T)
# ì¤‘ìš”ë„

ar = a.reshape(N, T, 1).repeat(H, axis = 2)
t=hs*ar # ì›ì†Œë³„ ê³±
# (10, 5, 4)
c = np.sum(t, axis=1)
# (10, 4)
```

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-11.png" alt="fig 8-11" style="zoom:50%;" /> 



- ì—­ì „íŒŒ êµ¬í˜„

```python
class WeightSum:
    def __init__(self):
        self.params, self.grads = [], []
        self.cache = None

    def forward(self, hs, a):
        N, T, H = hs.shape

        ar = a.reshape(N, T, 1) #.repeat(T, axis=1)
        t = hs * ar
        c = np.sum(t, axis=1)

        self.cache = (hs, ar)
        return c

    def backward(self, dc):
        hs, ar = self.cache
        N, T, H = hs.shape
        # sumì˜ ì—­ì „íŒŒëŠ” repeat
        dt = dc.reshape(N, 1, H).repeat(T, axis=1)
        dar = dt * hs
        dhs = dt * ar
        
        # repeatì˜ ì—­ì „íŒŒëŠ” sum
        da = np.sum(dar, axis=2)

        return dhs, da
```



### 1.4 Decoder ê°œì„ 2ï¸âƒ£

ğŸ™„ ìœ„ì—ì„œ ì„¤ì •í•œ ê°€ì¤‘ì¹˜ aëŠ” ì–´ë–»ê²Œ êµ¬í•´ì•¼í•˜ëŠ”ì§€ ì•Œì•„ë³´ì.

ìš°ì„  decoderì˜ ì²«ë²ˆì§¸ ì‹œê° LSTM ê³„ì¸µì´ ì€ë‹‰ ìƒíƒœ ë²¡í„°ë¥¼ ì¶œë ¥í•  ë–„ê°€ì§€ì˜ ì²˜ë¦¬ë¶€í„° ì‚´í´ë³¸ë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-12.png" alt="fig 8-12" style="zoom:50%;" /> 

decoderì˜ LSTM ê³„ì¸µì˜ ì€ë‹‰ ìƒíƒœë¥¼ hë¼ê³  í•œë‹¤. ì´ hê°€ hsì˜ ê° ë‹¨ì–´ ë²¡í„°ì™€ ì–¼ë§ˆë‚˜ ë¹„ìŠ·í•œì§€ë¥¼ ìˆ˜ì¹˜ë¡œ ë‚˜íƒ€ë‚´ì•¼í•œë‹¤.

ê°„ë‹¨í•œ ë°©ë²•ì€ ë²¡í„°ì˜ ë‚´ì ì„ ì´ìš©í•˜ëŠ” ê²ƒì´ë‹¤.

ë‚´ì ì˜ ìˆ˜ì‹ì€ ì•„ë˜ì™€ ê°™ë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/e 8-1.png" alt="e 8-1" style="zoom:50%;" /> 

ë‚´ì ì€ ë‘ ë²¡í„°ê°€ ì–¼ë§ˆë‚˜ ê°™ì€ ë°©í–¥ì„ í–¥í•˜ê³  ìˆëŠ”ì§€(ìœ ì‚¬ë„)ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.

ë‚´ì ì„ ì´ìš©í•œ ë²¡í„° ìœ ì‚¬ë„ ì‚°ì¶œ ì²˜ë¦¬ëŠ” ì•„ë˜ì™€ ê°™ì´ ë‚˜íƒ€ë‚¼ ìˆ˜ ìˆë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-13.png" alt="fig 8-13" style="zoom:50%;" /> 

```python
N, T, H = 10, 5, 4
hs = np.random.randn(N, T, H)
h = np.random.randn(N, T)
hr = a.reshape(N, T, 1).repeat(H, axis = 1)

t=hs*ar
# (10, 5, 4)
s = np.sum(t, axis=2)
# (10, 5)

softmax = Softmax()
a = softmax.forward(s)
# (10, 5)
```

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-15.png" alt="fig 8-15" style="zoom:50%;" /> 

```python
class AttentionWeight:
    def __init__(self):
        self.params, self.grads = [], []
        self.softmax = Softmax()
        self.cache = None

    def forward(self, hs, h):
        N, T, H = hs.shape

        hr = h.reshape(N, 1, H) # ë¸Œë¡œë“œìºìŠ¤íŠ¸ ì‚¬ìš©í•˜ëŠ” ê²½ìš°
        t = hs * hr
        s = np.sum(t, axis=2)
        a = self.softmax.forward(s)

        self.cache = (hs, hr)
        return a

    def backward(self, da):
        hs, hr = self.cache
        N, T, H = hs.shape

        ds = self.softmax.backward(da)
        dt = ds.reshape(N, T, 1).repeat(H, axis=2)
        dhs = dt * hr
        dhr = dt * hs
        dh = np.sum(dhr, axis=1)

        return dhs, dh
```



### 1.5 Decoder ê°œì„ 3ï¸âƒ£

ì•ì—ì„œ êµ¬í˜„í•˜ëŠ” weight sum ê³¼ attention weight ê³„ì¸µì„ í•˜ë‚˜ë¡œ ê²°í•©í•´ë³¸ë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-16.png" alt="fig 8-16" style="zoom:50%;" /> 

```python
class Attention:
    def __init__(self):
        self.params, self.grads = [], []
        self.attention_weight_layer = AttentionWeight()
        self.weight_sum_layer = WeightSum()
        self.attention_weight = None

    def forward(self, hs, h):
        a = self.attention_weight_layer.forward(hs, h)
        out = self.weight_sum_layer.forward(hs, a)
        self.attention_weight = a
        return out

    def backward(self, dout):
        dhs0, da = self.weight_sum_layer.backward(dout)
        dhs1, dh = self.attention_weight_layer.backward(da)
        dhs = dhs0 + dhs1
        return dhs, dh
```

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-18.png" alt="fig 8-18" style="zoom:50%;" />

ë§ˆì§€ë§‰ìœ¼ë¡œ ì‹œê³„ì—´ ë°©í–¥ìœ¼ë¡œ í¼ì³ì§„ ë‹¤ìˆ˜ì˜ Attention ê³„ì¸µì„ Time Ateention ê³„ì¸µìœ¼ë¡œ ëª¨ì•„ êµ¬í˜„í•œë‹¤.

```python
class TimeAttention:
    def __init__(self):
        self.params, self.grads = [], []
        self.layers = None
        self.attention_weights = None

    def forward(self, hs_enc, hs_dec):
        N, T, H = hs_dec.shape # T : Attention ê³„ì¸µì˜ ìˆ˜
        out = np.empty_like(hs_dec)
        self.layers = []
        self.attention_weights = []

        for t in range(T):
            layer = Attention()
            out[:, t, :] = layer.forward(hs_enc, hs_dec[:,t,:])
            self.layers.append(layer)
            self.attention_weights.append(layer.attention_weight)

        return out

    def backward(self, dout):
        N, T, H = dout.shape
        dhs_enc = 0
        dhs_dec = np.empty_like(dout)

        for t in range(T):
            layer = self.layers[t]
            dhs, dh = layer.backward(dout[:, t, :])
            dhs_enc += dhs
            dhs_dec[:,t,:] = dh

        return dhs_enc, dhs_dec
```



---





## 2. ì–´í…ì…˜ì„ ê°–ì¶˜ seq2seq êµ¬í˜„



### 2.1 Encoder êµ¬í˜„

```python
class AttentionEncoder(Encoder): # Encoder ìƒì†
    def forward(self, xs):
        xs = self.embed.forward(xs)
        hs = self.lstm.forward(xs)
        return hs # ëª¨ë“  ì€ë‹‰ìƒíƒœë¥¼ ë°˜í™˜

    def backward(self, dhs):
        dout = self.lstm.backward(dhs)
        dout = self.embed.backward(dout)
        return dout
```



### 2.2 Decoder êµ¬í˜„

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-21.png" alt="fig 8-21" style="zoom:50%;" /> 

```python
class AttentionDecoder:
    def __init__(self, vocab_size, wordvec_size, hidden_size):
        V, D, H = vocab_size, wordvec_size, hidden_size
        rn = np.random.randn

        embed_W = (rn(V, D) / 100).astype('f')
        lstm_Wx = (rn(D, 4 * H) / np.sqrt(D)).astype('f')
        lstm_Wh = (rn(H, 4 * H) / np.sqrt(H)).astype('f')
        lstm_b = np.zeros(4 * H).astype('f')
        affine_W = (rn(2*H, V) / np.sqrt(2*H)).astype('f')
        affine_b = np.zeros(V).astype('f')

        self.embed = TimeEmbedding(embed_W)
        self.lstm = TimeLSTM(lstm_Wx, lstm_Wh, lstm_b, stateful=True)
        self.attention = TimeAttention()
        self.affine = TimeAffine(affine_W, affine_b)
        layers = [self.embed, self.lstm, self.attention, self.affine]

        self.params, self.grads = [], []
        for layer in layers:
            self.params += layer.params
            self.grads += layer.grads

    def forward(self, xs, enc_hs):
        h = enc_hs[:,-1]
        self.lstm.set_state(h)

        out = self.embed.forward(xs)
        dec_hs = self.lstm.forward(out)
        
        # Time Attention ê³„ì¸µì˜ ì¶œë ¥ê³¼ LSTM ê³„ì¸µì˜ ì¶œë ¥ì„ ì—°ê²°
        c = self.attention.forward(enc_hs, dec_hs)
        out = np.concatenate((c, dec_hs), axis=2)
        
        score = self.affine.forward(out)

        return score

    def backward(self, dscore):
        dout = self.affine.backward(dscore)
        N, T, H2 = dout.shape
        H = H2 // 2

        dc, ddec_hs0 = dout[:,:,:H], dout[:,:,H:]
        denc_hs, ddec_hs1 = self.attention.backward(dc)
        ddec_hs = ddec_hs0 + ddec_hs1
        dout = self.lstm.backward(ddec_hs)
        dh = self.lstm.dh
        denc_hs[:, -1] += dh
        self.embed.backward(dout)

        return denc_hs

    # ìƒˆë¡œìš´ ë‹¨ì–´ì—´ ìƒì„±
    def generate(self, enc_hs, start_id, sample_size):
        sampled = []
        sample_id = start_id
        h = enc_hs[:, -1]
        self.lstm.set_state(h)

        for _ in range(sample_size):
            x = np.array([sample_id]).reshape((1, 1))

            out = self.embed.forward(x)
            dec_hs = self.lstm.forward(out)
            c = self.attention.forward(enc_hs, dec_hs)
            out = np.concatenate((c, dec_hs), axis=2)
            score = self.affine.forward(out)

            sample_id = np.argmax(score.flatten())
            sampled.append(sample_id)

        return sampled
```



### 2.3 seq2seq êµ¬í˜„

```python
class AttentionSeq2seq(Seq2seq): # seq2seq ìƒì†
    def __init__(self, vocab_size, wordvec_size, hidden_size):
        args = vocab_size, wordvec_size, hidden_size
        self.encoder = AttentionEncoder(*args)
        self.decoder = AttentionDecoder(*args)
        self.softmax = TimeSoftmaxWithLoss()

        self.params = self.encoder.params + self.decoder.params
        self.grads = self.encoder.grads + self.decoder.grads
```



---





## 3. ì–´í…ì…˜ í‰ê°€

ë‚ ì§œ í˜•ì‹ì„ ë³€ê²½í•˜ëŠ” ë¬¸ì œë¡œ ì–´í…ì…˜ì„ ê°–ì¶˜ seq2seq íš¨ê³¼ë¥¼ í™•ì¸í•´ë³¸ë‹¤.



### 3.1 ë‚ ì§œ í˜•ì‹ ë³€í™˜ ë¬¸ì œ

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-22.png" alt="fig 8-22" style="zoom:50%;" /> 

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-23.png" alt="fig 8-23" style="zoom:50%;" /> 



### 3.2 ì–´í…ì…˜ì„ ê°–ì¶˜ seq2seqì˜ í•™ìŠµ

```python
# ë°ì´í„° ì½ê¸°
(x_train, t_train), (x_test, t_test) = sequence.load_data('date.txt')
char_to_id, id_to_char = sequence.get_vocab()

# ì…ë ¥ ë¬¸ì¥ ë°˜ì „
x_train, x_test = x_train[:, ::-1], x_test[:, ::-1]

# í•˜ì´í¼íŒŒë¼ë¯¸í„° ì„¤ì •
vocab_size = len(char_to_id)
wordvec_size = 16
hidden_size = 256
batch_size = 128
max_epoch = 10
max_grad = 5.0

model = AttentionSeq2seq(vocab_size, wordvec_size, hidden_size)
# model = Seq2seq(vocab_size, wordvec_size, hidden_size)
# model = PeekySeq2seq(vocab_size, wordvec_size, hidden_size)

optimizer = Adam()
trainer = Trainer(model, optimizer)

acc_list = []
for epoch in range(max_epoch):
    trainer.fit(x_train, t_train, max_epoch=1,
                batch_size=batch_size, max_grad=max_grad)

    correct_num = 0
    for i in range(len(x_test)):
        question, correct = x_test[[i]], t_test[[i]]
        verbose = i < 10
        correct_num += eval_seq2seq(model, question, correct,
                                    id_to_char, verbose, is_reverse=True)

    acc = float(correct_num) / len(x_test)
    acc_list.append(acc)
```

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-25.png" alt="fig 8-25" style="zoom: 33%;" /> <img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-26.png" alt="fig 8-26" style="zoom:33%;" />





### 3.3 ì–´í…ì…˜ ì‹œê°í™”

Attention ê³„ì¸µì€ ê° ì‹œê°ì˜ ì–´í…ì…˜ ê°€ì¤‘ì¹˜ë¥¼ ì¸ìŠ¤í„´ìŠ¤ ë³€ìˆ˜ë¡œ ë³´ê´€í•˜ê³  ìˆë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-27.png" alt="fig 8-27" style="zoom:50%;" />

ì‹œê°í™”ë¥¼ í†µí•´ ëª¨ë¸ì´ ìˆ˜í–‰í•˜ëŠ” ìˆœê°„ì— ì–´ë””ì— ì§‘ì¤‘í•˜ëŠ” í™•ì¸í•  ìˆ˜ ìˆë‹¤.



---





## 4. ì–´í…ì…˜ì— ê´€í•œ ë‚¨ì€ ì´ì•¼ê¸°



### 4.1 ì–‘ë°©í–¥ RNN

ì•ì¥ê¹Œì§€ ë°°ìš´ Encoder ê³„ì¸µì— ì§‘ì¤‘í•´ë³¸ë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-29.png" alt="fig 8-29" style="zoom:50%;" /> 

LSTMì„ ì–‘ë°©í–¥ìœ¼ë¡œ ì²˜ë¦¬í•˜ëŠ” ë°©ë²•ì„ ìƒê°í•  ìˆ˜ ìˆë‹¤. ì´ê²ƒì´ ì–‘ë°©í–¥ LSTMê¸°ìˆ ì´ë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-30.png" alt="fig 8-30" style="zoom:50%;" /> 

ê° ì‹œê°ì—ì„œëŠ” ë‘ LSTM ê³„ì¸µì˜ ì€ë‹‰ ìƒíƒœë¥¼ ì—°ê²°ì‹œí‚¨ ë²¡í„°ë¥¼ ìµœì¢… ì€ë‹‰ ìƒíƒœë¡œ ì²˜ë¦¬í•œë‹¤.

ì´ë ‡ê²Œ ì–‘ë°©í–¥ìœ¼ë¡œ ì€ë‹‰ ìƒíƒœë¥¼ ì²˜ë¦¬í•˜ë©´ ê° ë‹¨ì–´ì— ëŒ€ì‘í•˜ëŠ” ì€ë‹‰ ìƒíƒœ ë²¡í„°ì—ëŠ” ì–‘ìª½ ë°©í–¥ìœ¼ë¡œë¶€í„°ì˜ ì •ë³´ë¥¼ ì§‘ì•½í•  ìˆ˜ ìˆë‹¤.



### 4.2 ì–´í…ì…˜ ê³„ì¸µ ì‚¬ìš© ë°©ë²•

ì–´í…ì…˜ ê³„ì¸µì˜ ìœ„ì¹˜ëŠ” ììœ ë¡­ê²Œ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-31.png" alt="fig 8-31" style="zoom:50%;" /> 

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-32.png" alt="fig 8-32" style="zoom:50%;" /> 



### 4.3 seq2seq ì‹¬ì¸µí™”ì™€ skip ì—°ê²°

ë³µì¡í•œ ë¬¸ì œ í’€ì´ë¥¼ ìœ„í•´ì„œëŠ” ë” ë†’ì€ ì„±ëŠ¥ì˜ ì–´í…ì…˜ì„ ê°–ì¶˜ seq2seqê°€ í•„ìš”í•œë‹¤.

LSTM ê³„ì¸µì„ ê¹Šê²Œ ìŒ“ëŠ” ë°©ë²•ì´ ìˆë‹¤.

ê¹Šê²Œ ì¸µì„ ìŒ“ìœ¼ë©´ í‘œí˜„ë ¥ ë†’ì€ ëª¨ë¸ì„ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-33.png" alt="fig 8-33" style="zoom:50%;" /> 

ì¸µì„ ê¹Šê²Œ í•  ë–„ ì‚¬ìš©ë˜ëŠ” ì¤‘ìš”í•œ ê¸°ë²• ì¤‘ skip ì—°ê²°ì´ ìˆë‹¤. 

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-34.png" alt="fig 8-34" style="zoom:50%;" /> 

skip ì—°ê²°ì€ ê³„ì¸µì„ ê±´ë„ˆë’¤ëŠ” ì—°ê²°ì´ë‹¤. skip ì—°ê²°ì˜ ì ‘ì†ë¶€ì—ì„œëŠ” 2ê°œì˜ ì¶œë ¥ì´ ë”í•´ì§„ë‹¤. 

(ë”í•´ì§€ëŠ” ê²ƒì˜ ì—­ì „íŒŒì—ì„œ ê¸°ìš¸ê¸° ì†Œì‹¤ë˜ì§€ ì•Šê³  ì „íŒŒëœë‹¤.)



---





## 5. ì–´í…ì…˜ ì‘ìš©

ì–´í…ì…˜ì˜ ì•„ì´ë””ì–´ëŠ” ë²”ìš©ì ìœ¼ë¡œ í™œìš©ì´ ê°€ëŠ¥í•˜ë‹¤.



### 5.1 êµ¬ê¸€ ì‹ ê²½ë§ ê¸°ê³„ ë²ˆì—­(GNMT)

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-35.png" alt="fig 8-35" style="zoom:50%;" /> 

- LSTM ë‹¤ì¸µí™”, ì–‘ë°©í–¥ LSTM, skip ì—°ê²° ë“±



### 5.2 íŠ¸ëœìŠ¤í¬ë¨¸

RNNì˜ ë‹¨ì ìœ¼ë¡œ ë³‘ë ¬ ì²˜ë¦¬ë¥¼ ë“¤ ìˆ˜ ìˆë‹¤.

ì´ì „ ì‹œê°ì— ê³„ì‚°í•œ ê²°ê³¼ë¥¼ ì´ìš©í•˜ì—¬ ìˆœì„œëŒ€ë¡œ ê³„ì‚°í•˜ì—¬ì•¼í•˜ë¯€ë¡œ ë³‘ë ¬ ê³„ì‚°ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤.

ë•Œë¬¸ì— RNNì„ ì—†ì• ëŠ” ì—°êµ¬ê°€ í™œë°œíˆ ì´ë¤„ì§€ê³  ìˆë‹¤. ê·¸ ì¤‘í•˜ë‚˜ê°€ íŠ¸ëœìŠ¤í¬ë¨¸ì´ë‹¤.

íŠ¸ëœìŠ¤í¬ë¨¸ : ì…€í”„ì–´í…ì…˜(í•˜ë‚˜ì˜ ì‹œê³„ì—´ ë°ì´í„°ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•œ ì–´í…ì…˜)ì„ ì‚¬ìš©í•œ ëª¨ë¸

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-37.png" alt="fig 8-37" style="zoom:50%;" /> 

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-38.png" alt="fig 8-38" style="zoom:50%;" /> 

ì…€í”„ì–´í…ì…˜ì€ ë‘ ì…ë ¥ì„  ëª¨ë‘ í•˜ë‚˜ì˜ ì‹œê³„ì—´ ë°ì´í„°ë¡œë¶€í„° ë‚˜ì˜¤ê¸°ë•Œë¬¸ì— í•˜ë‚˜ì˜ ì‹œê³„ì—´ ë°ì´í„° ë‚´ì—ì„œì˜ ì›ì†Œ ê°„ ëŒ€ì‘ ê´€ê³„ê°€ êµ¬í•´ì§„ë‹¤.



### 5.3 ë‰´ëŸ´ íŠœë§ ë¨¸ì‹ (NTM)

NTM : ì™¸ë¶€ ë©”ëª¨ë¦¬ë¥¼ ì½ê³  ì“°ë©´ì„œ ì‹œê³„ì—´ ë°ì´í„°ë¥¼ ì²˜ë¦¬í•œë‹¤.

ì–´í…ì…˜ì„ í†µí•´ encoder, decoderëŠ” ë©”ëª¨ë¦¬ ì¡°ì‘ê°™ì€ ì‘ì—…ì„ ìˆ˜í–‰í•œë‹¤.

ì¦‰, encoderê°€ í•„ìš”í•œ ì •ë³´ë¥¼ ë©”ëª¨ë¦¬ì— ì“°ê³ , decoderëŠ” ê·¸ ë©”ëª¨ë¦¬ë¡œë¶€í„° í•„ìš”í•œ ì •ë³´ë¥¼ ì½ì–´ ë“¤ì¸ë‹¤.

RNNì˜ ì™¸ë¶€ì— ì •ë³´ ì •ë³´ ì €ì¥ìš© ë©”ëª¨ë¦¬ ê¸°ëŠ¥ì„ ë°°ì¹˜í•˜ê³  ì–´í…ì…˜ì„ ì´ìš©í•˜ì—¬ ê·¸ ë©”ëª¨ë¦¬ë¡œë¶€í„° í•„ìš”í•œ ì •ë³´ë¥¼ ì½ê±°ë‚˜ ì“°ëŠ” ë°©ë²•ì´ë‹¤.

ì»¨íŠ¸ë¡¤ëŸ¬ë¼ëŠ” ëª¨ë“ˆì€ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ëª¨ë“ˆë¡œ ì‹ ê²½ë§ì„ ì´ìš©í•œë‹¤.

ë©”ëª¨ë¦¬ëŠ” ì •ë³´ë¥¼ ì“°ê±°ë‚˜ ë¶ˆí•„ìš”í•œ ì •ë³´ë¥¼ ì§€ìš°ëŠ” ëŠ¥ë ¥ì´ ìˆë‹¤. 

<img src="ë°‘ì‹œë”¥2 8. ì–´í…ì…˜.assets/fig 8-41.png" alt="fig 8-41" style="zoom:50%;" /> 

NTMì€ ì»´í“¨í„° ë©”ëª¨ë¦¬ ì¡°ì‘ì„ ëª¨ë°©í•˜ê¸° ìœ„í•´ 2ê°œì˜ ì–´í…ì…˜ì„ ì´ìš©í•œë‹¤.

ì½˜í…ì¸  ê¸°ë°˜ ì–´í…ì…˜ + ìœ„ì¹˜ ê¸°ë°˜ ì–´í…ì…˜(ì…ë ¥ ë²¡í„°ì™€ ë¹„ìŠ·í•œ ë²¡í„°ë¥¼ ë©”ëª¨ë¦¬ì—ì„œ ì°¾ëŠ” ìš©ë„)

